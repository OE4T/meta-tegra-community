From 8d3468edafb07f4566f1b4d8c5784dbfbd5906de Mon Sep 17 00:00:00 2001
From: Ilies CHERGUI <ichergui@nvidia.com>
Date: Fri, 5 Sep 2025 10:46:15 +0100
Subject: [PATCH] Updates for OE cross builds

Those changes are based on the following commit:
https://github.com/NVIDIA/cccl/pull/5782

Upstream-Status: Inappropriate [OE-specific]
Signed-off-by: Ilies CHERGUI <ichergui@nvidia.com>
---
 include/cuda/std/__cccl/builtin.h | 20 +++++++++
 include/cuda/std/__cmath/traits.h | 70 ++++++++++++++++++++++++++++---
 2 files changed, 85 insertions(+), 5 deletions(-)

diff --git a/include/cuda/std/__cccl/builtin.h b/include/cuda/std/__cccl/builtin.h
index 55e2f02..f181a8a 100644
--- a/include/cuda/std/__cccl/builtin.h
+++ b/include/cuda/std/__cccl/builtin.h
@@ -261,6 +261,26 @@
 #  define _CCCL_BUILTIN_ISNAN(...) __builtin_isnan(__VA_ARGS__)
 #endif // _CCCL_CHECK_BUILTIN(isnan)
 
+#if _CCCL_CHECK_BUILTIN(builtin_isgreater) || _CCCL_COMPILER(GCC)
+#  define _CCCL_BUILTIN_ISGREATER(...) __builtin_isgreater(__VA_ARGS__)
+#endif // _CCCL_CHECK_BUILTIN(builtin_isgreater)
+
+#if _CCCL_CHECK_BUILTIN(builtin_isgreaterequal) || _CCCL_COMPILER(GCC)
+#  define _CCCL_BUILTIN_ISGREATEREQUAL(...) __builtin_isgreaterequal(__VA_ARGS__)
+#endif // _CCCL_CHECK_BUILTIN(builtin_isgreaterequal)
+
+#if _CCCL_CHECK_BUILTIN(builtin_isless) || _CCCL_COMPILER(GCC)
+#  define _CCCL_BUILTIN_ISLESS(...) __builtin_isless(__VA_ARGS__)
+#endif // _CCCL_CHECK_BUILTIN(builtin_isless)
+
+#if _CCCL_CHECK_BUILTIN(builtin_islessequal) || _CCCL_COMPILER(GCC)
+#  define _CCCL_BUILTIN_ISLESSEQUAL(...) __builtin_islessequal(__VA_ARGS__)
+#endif // _CCCL_CHECK_BUILTIN(builtin_islessequal)
+
+#if _CCCL_CHECK_BUILTIN(builtin_islessgreater) || _CCCL_COMPILER(GCC)
+#  define _CCCL_BUILTIN_ISLESSGREATER(...) __builtin_islessgreater(__VA_ARGS__)
+#endif // _CCCL_CHECK_BUILTIN(builtin_islessgreater)
+
 // Below 11.7 nvcc treats the builtin as a host only function
 #if _CCCL_CUDACC_BELOW(11, 7)
 #  undef _CCCL_BUILTIN_ISNAN
diff --git a/include/cuda/std/__cmath/traits.h b/include/cuda/std/__cmath/traits.h
index cdfe4a8..d73456f 100644
--- a/include/cuda/std/__cmath/traits.h
+++ b/include/cuda/std/__cmath/traits.h
@@ -351,6 +351,18 @@ _CCCL_NODISCARD _CCCL_DEVICE _CCCL_HIDE_FROM_ABI bool __device_isgreater(_A1 __x
   return __x > __y;
 }
 
+#if !_CCCL_COMPILER(NVRTC)
+template <class _A1, enable_if_t<_CCCL_TRAIT(__is_extended_arithmetic, _A1), int> = 0>
+_CCCL_NODISCARD _CCCL_HIDE_FROM_ABI bool __host_isgreater(_A1 __x, _A1 __y) noexcept
+{
+#  if defined(_CCCL_BUILTIN_ISGREATER)
+  return _CCCL_BUILTIN_ISGREATER(__x, __y);
+#  else // ^^^ _CCCL_BUILTIN_ISGREATER ^^^ / vvv !_CCCL_BUILTIN_ISGREATER vvv
+  return ::isgreater(__x, __y);
+#  endif // !_CCCL_BUILTIN_ISGREATER
+}
+#endif // !_CCCL_COMPILER(NVRTC)
+
 template <class _A1,
           class _A2,
           enable_if_t<_CCCL_TRAIT(__is_extended_arithmetic, _A1) && _CCCL_TRAIT(__is_extended_arithmetic, _A2), int> = 0>
@@ -358,7 +370,7 @@ _CCCL_NODISCARD _LIBCUDACXX_HIDE_FROM_ABI bool isgreater(_A1 __x, _A2 __y) noexc
 {
   using type = __promote_t<_A1, _A2>;
   NV_IF_ELSE_TARGET(NV_IS_HOST,
-                    (return ::isgreater((type) __x, (type) __y);),
+                    (return _CUDA_VSTD::__host_isgreater((type) __x, (type) __y);),
                     (return _CUDA_VSTD::__device_isgreater((type) __x, (type) __y);))
 }
 
@@ -374,6 +386,18 @@ _CCCL_NODISCARD _CCCL_DEVICE _CCCL_HIDE_FROM_ABI bool __device_isgreaterequal(_A
   return __x >= __y;
 }
 
+#if !_CCCL_COMPILER(NVRTC)
+template <class _A1, enable_if_t<_CCCL_TRAIT(__is_extended_arithmetic, _A1), int> = 0>
+_CCCL_NODISCARD _CCCL_HIDE_FROM_ABI bool __host_isgreaterequal(_A1 __x, _A1 __y) noexcept
+{
+#  if defined(_CCCL_BUILTIN_ISGREATEREQUAL)
+  return _CCCL_BUILTIN_ISGREATEREQUAL(__x, __y);
+#  else // ^^^ _CCCL_BUILTIN_ISGREATEREQUAL ^^^ / vvv !_CCCL_BUILTIN_ISGREATEREQUAL vvv
+  return ::isgreaterequal(__x, __y);
+#  endif // !_CCCL_BUILTIN_ISGREATEREQUAL
+}
+#endif // !_CCCL_COMPILER(NVRTC)
+
 template <class _A1,
           class _A2,
           enable_if_t<_CCCL_TRAIT(__is_extended_arithmetic, _A1) && _CCCL_TRAIT(__is_extended_arithmetic, _A2), int> = 0>
@@ -381,7 +405,7 @@ _CCCL_NODISCARD _LIBCUDACXX_HIDE_FROM_ABI bool isgreaterequal(_A1 __x, _A2 __y)
 {
   using type = __promote_t<_A1, _A2>;
   NV_IF_ELSE_TARGET(NV_IS_HOST,
-                    (return ::isgreaterequal((type) __x, (type) __y);),
+                    (return _CUDA_VSTD::__host_isgreaterequal((type) __x, (type) __y);),
                     (return _CUDA_VSTD::__device_isgreaterequal((type) __x, (type) __y);))
 }
 
@@ -397,6 +421,18 @@ _CCCL_NODISCARD _CCCL_DEVICE _CCCL_HIDE_FROM_ABI bool __device_isless(_A1 __x, _
   return __x < __y;
 }
 
+#if !_CCCL_COMPILER(NVRTC)
+template <class _A1, enable_if_t<_CCCL_TRAIT(__is_extended_arithmetic, _A1), int> = 0>
+_CCCL_NODISCARD _CCCL_HIDE_FROM_ABI bool __host_isless(_A1 __x, _A1 __y) noexcept
+{
+#  if defined(_CCCL_BUILTIN_ISLESS)
+  return _CCCL_BUILTIN_ISLESS(__x, __y);
+#  else // ^^^ _CCCL_BUILTIN_ISLESS ^^^ / vvv !_CCCL_BUILTIN_ISLESS vvv
+  return ::isless(__x, __y);
+#  endif // !_CCCL_BUILTIN_ISLESS
+}
+#endif // !_CCCL_COMPILER(NVRTC)
+
 template <class _A1,
           class _A2,
           enable_if_t<_CCCL_TRAIT(__is_extended_arithmetic, _A1) && _CCCL_TRAIT(__is_extended_arithmetic, _A2), int> = 0>
@@ -404,7 +440,7 @@ _CCCL_NODISCARD _LIBCUDACXX_HIDE_FROM_ABI bool isless(_A1 __x, _A2 __y) noexcept
 {
   using type = __promote_t<_A1, _A2>;
   NV_IF_ELSE_TARGET(NV_IS_HOST,
-                    (return ::isless((type) __x, (type) __y);),
+                    (return _CUDA_VSTD::__host_isless((type) __x, (type) __y);),
                     (return _CUDA_VSTD::__device_isless((type) __x, (type) __y);))
 }
 
@@ -420,6 +456,18 @@ _CCCL_NODISCARD _CCCL_DEVICE _CCCL_HIDE_FROM_ABI bool __device_islessequal(_A1 _
   return __x <= __y;
 }
 
+#if !_CCCL_COMPILER(NVRTC)
+template <class _A1, enable_if_t<_CCCL_TRAIT(__is_extended_arithmetic, _A1), int> = 0>
+_CCCL_NODISCARD _CCCL_HIDE_FROM_ABI bool __host_islessequal(_A1 __x, _A1 __y) noexcept
+{
+#  if defined(_CCCL_BUILTIN_ISLESSEQUAL)
+  return _CCCL_BUILTIN_ISLESSEQUAL(__x, __y);
+#  else // ^^^ _CCCL_BUILTIN_ISLESSEQUAL ^^^ / vvv !_CCCL_BUILTIN_ISLESSEQUAL vvv
+  return ::islessequal(__x, __y);
+#  endif // !_CCCL_BUILTIN_ISLESSEQUAL
+}
+#endif // !_CCCL_COMPILER(NVRTC)
+
 template <class _A1,
           class _A2,
           enable_if_t<_CCCL_TRAIT(__is_extended_arithmetic, _A1) && _CCCL_TRAIT(__is_extended_arithmetic, _A2), int> = 0>
@@ -427,7 +475,7 @@ _CCCL_NODISCARD _LIBCUDACXX_HIDE_FROM_ABI bool islessequal(_A1 __x, _A2 __y) noe
 {
   using type = __promote_t<_A1, _A2>;
   NV_IF_ELSE_TARGET(NV_IS_HOST,
-                    (return ::islessequal((type) __x, (type) __y);),
+                    (return _CUDA_VSTD::__host_islessequal((type) __x, (type) __y);),
                     (return _CUDA_VSTD::__device_islessequal((type) __x, (type) __y);))
 }
 
@@ -443,6 +491,18 @@ _CCCL_NODISCARD _CCCL_DEVICE _CCCL_HIDE_FROM_ABI bool __device_islessgreater(_A1
   return __x < __y || __x > __y;
 }
 
+#if !_CCCL_COMPILER(NVRTC)
+template <class _A1, enable_if_t<_CCCL_TRAIT(__is_extended_arithmetic, _A1), int> = 0>
+_CCCL_NODISCARD _CCCL_HIDE_FROM_ABI bool __host_islessgreater(_A1 __x, _A1 __y) noexcept
+{
+#  if defined(_CCCL_BUILTIN_ISLESSGREATER)
+  return _CCCL_BUILTIN_ISLESSGREATER(__x, __y);
+#  else // ^^^ _CCCL_BUILTIN_ISLESSGREATER ^^^ / vvv !_CCCL_BUILTIN_ISLESSGREATER vvv
+  return ::islessgreater(__x, __y);
+#  endif // !_CCCL_BUILTIN_ISLESSGREATER
+}
+#endif // !_CCCL_COMPILER(NVRTC)
+
 template <class _A1,
           class _A2,
           enable_if_t<_CCCL_TRAIT(__is_extended_arithmetic, _A1) && _CCCL_TRAIT(__is_extended_arithmetic, _A2), int> = 0>
@@ -450,7 +510,7 @@ _CCCL_NODISCARD _LIBCUDACXX_HIDE_FROM_ABI bool islessgreater(_A1 __x, _A2 __y) n
 {
   using type = __promote_t<_A1, _A2>;
   NV_IF_ELSE_TARGET(NV_IS_HOST,
-                    (return ::islessgreater((type) __x, (type) __y);),
+                    (return _CUDA_VSTD::__host_islessgreater((type) __x, (type) __y);),
                     (return _CUDA_VSTD::__device_islessgreater((type) __x, (type) __y);))
 }
 
-- 
2.34.1

