From 629c65f4bd019de7d4de12d17df5c3f9858d1ecb Mon Sep 17 00:00:00 2001
From: Ilies CHERGUI <ichergui@nvidia.com>
Date: Mon, 29 Jan 2024 13:40:35 +0000
Subject: [PATCH] OE cross build fixups

Signed-off-by: Ilies CHERGUI <ichergui@nvidia.com>
---
 lib/systemd/system/jetson-networking.service           |  1 -
 .../jetson-1.0/services/gpumonitoring/entrypoint.sh    |  7 +------
 .../jetson-1.0/services/gpumonitoring/gpu_module.py    |  4 ++--
 .../jetson-1.0/services/gpumonitoring/requirements.txt | 10 ----------
 .../services/storage/bin/jetson-storage-setup          |  2 +-
 5 files changed, 4 insertions(+), 20 deletions(-)
 delete mode 100644 opt/nvidia/jetson-1.0/services/gpumonitoring/requirements.txt

diff --git a/lib/systemd/system/jetson-networking.service b/lib/systemd/system/jetson-networking.service
index 1e4cef5..684fd39 100644
--- a/lib/systemd/system/jetson-networking.service
+++ b/lib/systemd/system/jetson-networking.service
@@ -2,7 +2,6 @@
 Description=Jetson network setup service
 DefaultDependencies=no
 Before=systemd-networkd.service
-Before=NetworkManager.service
 
 [Service]
 Type=simple
diff --git a/opt/nvidia/jetson-1.0/services/gpumonitoring/entrypoint.sh b/opt/nvidia/jetson-1.0/services/gpumonitoring/entrypoint.sh
index 822938a..5122f73 100755
--- a/opt/nvidia/jetson-1.0/services/gpumonitoring/entrypoint.sh
+++ b/opt/nvidia/jetson-1.0/services/gpumonitoring/entrypoint.sh
@@ -59,9 +59,4 @@ set -e
 [ -z "$PUSH_GATEWAY_URL" ] && echo "No valid pushway gateway" && exit 1
 
 echo "Pushing metric to $PUSH_GATEWAY_URL"
-
-sudo apt update
-sudo apt install python3-pip -y
-
-pip3 install -r $SCRIPT_PATH/requirements.txt
-sudo -E python3 $SCRIPT_PATH/__main__.py
\ No newline at end of file
+python3 $SCRIPT_PATH/__main__.py
diff --git a/opt/nvidia/jetson-1.0/services/gpumonitoring/gpu_module.py b/opt/nvidia/jetson-1.0/services/gpumonitoring/gpu_module.py
index 0c58a23..817ed9a 100644
--- a/opt/nvidia/jetson-1.0/services/gpumonitoring/gpu_module.py
+++ b/opt/nvidia/jetson-1.0/services/gpumonitoring/gpu_module.py
@@ -82,7 +82,7 @@ class GpuModule:
             logger.exception("Unable to nullify GPU data !!!")
 
     def _get_per_process_gpu_stats(self):
-        script = "sudo cat /sys/kernel/debug/nvmap/iovmm/clients"
+        script = "cat /sys/kernel/debug/nvmap/iovmm/clients"
         self.per_process_usage = {}
         try:
             output = subprocess.run(script.split(' '), stdout=subprocess.PIPE, timeout=1)
@@ -103,7 +103,7 @@ class GpuModule:
         self.per_process_usage = process_mem_usage
 
     def _get_tegra_stats(self):
-        script = "sudo timeout 0.2 tegrastats --load_cfg ./tstats.txt --interval 100"
+        script = "timeout 0.2 tegrastats --load_cfg ./tstats.txt --interval 100"
         self.tegra_stats = ""
 
         try:
diff --git a/opt/nvidia/jetson-1.0/services/gpumonitoring/requirements.txt b/opt/nvidia/jetson-1.0/services/gpumonitoring/requirements.txt
deleted file mode 100644
index 4510f17..0000000
--- a/opt/nvidia/jetson-1.0/services/gpumonitoring/requirements.txt
+++ /dev/null
@@ -1,10 +0,0 @@
-#
-# This file is autogenerated by pip-compile
-# To update, run:
-#
-#    pip-compile
-#
-prometheus-client==0.12.0
-    # via gpu-parser (setup.py)
-pyhumps==3.5.0
-    # via gpu-parser (setup.py)
diff --git a/opt/nvidia/jetson-1.0/services/storage/bin/jetson-storage-setup b/opt/nvidia/jetson-1.0/services/storage/bin/jetson-storage-setup
index 06da510..8fb625e 100755
--- a/opt/nvidia/jetson-1.0/services/storage/bin/jetson-storage-setup
+++ b/opt/nvidia/jetson-1.0/services/storage/bin/jetson-storage-setup
@@ -149,7 +149,7 @@ extend_vg() {
 
 create_default_lv() {
 	create_default_vg
-	local PE_NUM=$(sudo vgdisplay | grep "Free  PE / Size" | tr -s '[:blank:]' | cut -d' ' -f 6)
+	local PE_NUM=$(vgdisplay | grep "Free  PE / Size" | tr -s '[:blank:]' | cut -d' ' -f 6)
 	info "Creating default LV $JETSON_LV with VG $JETSON_VG ..."
 	lvcreate --yes -l $PE_NUM -n "$JETSON_LV" "$JETSON_VG"
 	mkfs.ext4 "$LVM_PATH"
-- 
2.34.1

